name: CI/CD Frontend and Integration Lab

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  # JOB 1: BUILD FRONTEND
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code Frontend
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install and Build
        run: |
          npm install
          npm run build

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'

  # JOB 2: CHẠY LAB VỚI BACKEND (Chỉ chạy khi Build xong)
  integration-test:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: 1. Checkout Backend (Repo B)
        uses: actions/checkout@v4
        with:
          repository: Andrew250602/voiceBE
          token: ${{ secrets.MY_PAT }}
          path: backend-dir

      - name: 2. Start Backend Lab (Docker)
        run: |
          cd backend-dir
          # Đã sửa thành 'docker compose' để tránh lỗi command not found
          docker compose up -d
          
      - name: 3. Test Connection
        run: |
          echo "Đang kiểm tra kết nối tới Backend..."
          # Đợi tối đa 60s cho Backend khởi động
          timeout 60s bash -c 'until curl -s http://localhost:8080/api/health; do sleep 5; done' || (echo "Backend 403 hoặc không phản hồi" && docker ps -a)

  # JOB 3: DEPLOY (Chỉ chạy khi cả Build và Test Lab đều thành công)
  deploy:
    needs: [build, integration-test] # Cần cả 2 job trước thành công
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4